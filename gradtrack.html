<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GradTrack | Application Manager</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // --- Icons ---
    const Icons = {
        Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
        Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>,
        Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>,
        Mail: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>,
        CheckSquare: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>,
        Square: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>,
        ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>,
        Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
        Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
        Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>,
        ExternalLink: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" y1="14" x2="21" y2="3" /></svg>,
        Minimize: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
        X: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
        List: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>,
        SortAsc: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 5h10"></path><path d="M11 9h7"></path><path d="M11 13h4"></path><path d="M3 17l3 3 3-3"></path><path d="M6 18V4"></path></svg>,
    };

    // --- Persistence Helper ---
    const STORAGE_KEY = 'gradtrack_data';
    const TODO_KEY = 'gradtrack_todos';

    const DefaultChecklist = [
        { id: 'account', text: 'Portal Account', completed: false },
        { id: 'transcripts', text: 'Transcripts', completed: false },
        { id: 'scores', text: 'Test Scores', completed: false },
        { id: 'lor', text: 'LORs', completed: false },
        { id: 'sop', text: 'SOP/Essay', completed: false },
        { id: 'fee', text: 'App Fee', completed: false }
    ];
    
    const loadData = () => {
        try {
            const data = localStorage.getItem(STORAGE_KEY);
            if (!data) return [];
            let parsed = JSON.parse(data);
            
            // Data Migration Logic
            return parsed.map(app => {
                // Convert old object checklist to new array format if needed
                if (app.checklist && !Array.isArray(app.checklist)) {
                    const newChecklist = DefaultChecklist.map(item => ({
                        ...item,
                        completed: !!app.checklist[item.id]
                    }));
                    return { ...app, checklist: newChecklist };
                }
                // Ensure checklist exists if missing
                if (!app.checklist) {
                    return { ...app, checklist: [...DefaultChecklist] };
                }
                return app;
            });
        } catch (e) {
            console.error("Failed to load data", e);
            return [];
        }
    };

    const saveData = (data) => {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch (e) {
            console.error("Failed to save data", e);
        }
    };

    // --- Daily To-Do Component ---
    const DailyToDo = () => {
        const [todos, setTodos] = useState([]);
        const [input, setInput] = useState("");
        const [isOpen, setIsOpen] = useState(true);

        useEffect(() => {
            try {
                const saved = localStorage.getItem(TODO_KEY);
                if (saved) setTodos(JSON.parse(saved));
            } catch (e) {
                console.error("Failed to load todos", e);
            }
        }, []);

        const updateTodos = (newTodos) => {
            setTodos(newTodos);
            localStorage.setItem(TODO_KEY, JSON.stringify(newTodos));
        };

        const addTodo = (e) => {
            e.preventDefault();
            if (!input.trim()) return;
            const newTodo = { id: Date.now(), text: input, completed: false };
            updateTodos([...todos, newTodo]);
            setInput("");
        };

        const toggleTodo = (id) => {
            const newTodos = todos.map(t => t.id === id ? { ...t, completed: !t.completed } : t);
            updateTodos(newTodos);
        };

        const deleteTodo = (id) => {
            const newTodos = todos.filter(t => t.id !== id);
            updateTodos(newTodos);
        };

        if (!isOpen) {
            return (
                <button 
                    onClick={() => setIsOpen(true)}
                    className="fixed bottom-6 right-6 bg-gray-900 text-white p-4 rounded-full shadow-xl hover:bg-black transition-all hover:scale-105 z-50 flex items-center gap-2"
                >
                    <Icons.List />
                    <span className="font-medium pr-1">To-Do</span>
                    {todos.filter(t => !t.completed).length > 0 && (
                        <span className="bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full">
                            {todos.filter(t => !t.completed).length}
                        </span>
                    )}
                </button>
            );
        }

        return (
            <div className="fixed bottom-6 right-6 w-80 bg-white rounded-xl shadow-2xl border border-gray-200 z-50 flex flex-col animate-in slide-in-from-bottom-4 duration-300">
                <div className="flex justify-between items-center p-4 border-b border-gray-100 bg-gray-50 rounded-t-xl">
                    <div className="flex items-center gap-2">
                        <Icons.List />
                        <h3 className="font-bold text-gray-800">Daily Focus</h3>
                    </div>
                    <button onClick={() => setIsOpen(false)} className="text-gray-400 hover:text-gray-600">
                        <Icons.Minimize />
                    </button>
                </div>
                
                <div className="p-4 max-h-64 overflow-y-auto scrollbar-hide">
                    {todos.length === 0 && (
                        <p className="text-sm text-gray-400 text-center py-4 italic">No tasks yet. Stay focused!</p>
                    )}
                    <ul className="space-y-2">
                        {todos.map(todo => (
                            <li key={todo.id} className="flex items-center gap-2 group">
                                <button 
                                    onClick={() => toggleTodo(todo.id)}
                                    className={`flex-shrink-0 transition-colors ${todo.completed ? "text-emerald-500" : "text-gray-300 hover:text-gray-400"}`}
                                >
                                    {todo.completed ? <Icons.CheckSquare /> : <Icons.Square />}
                                </button>
                                <span className={`text-sm flex-1 break-words ${todo.completed ? "line-through text-gray-400" : "text-gray-700"}`}>
                                    {todo.text}
                                </span>
                                <button 
                                    onClick={() => deleteTodo(todo.id)}
                                    className="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                >
                                    <Icons.X />
                                </button>
                            </li>
                        ))}
                    </ul>
                </div>

                <form onSubmit={addTodo} className="p-4 border-t border-gray-100">
                    <div className="flex gap-2">
                        <input
                            type="text"
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            placeholder="Add a task..."
                            className="flex-1 text-sm border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        />
                        <button 
                            type="submit" 
                            disabled={!input.trim()}
                            className="bg-gray-900 text-white rounded-lg px-3 hover:bg-black disabled:opacity-50"
                        >
                            <Icons.Plus />
                        </button>
                    </div>
                </form>
            </div>
        );
    };

    // --- Modal Component ---
    const Modal = ({ isOpen, onClose, title, children }) => {
        if (!isOpen) return null;
        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm p-4">
                <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden animate-in fade-in zoom-in duration-200">
                    <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                        <h3 className="font-semibold text-lg text-gray-800">{title}</h3>
                        <button onClick={onClose} className="text-gray-400 hover:text-gray-600">âœ•</button>
                    </div>
                    <div className="p-6">{children}</div>
                </div>
            </div>
        );
    };

    // --- Editable Date Component ---
    const EditableDate = ({ date, onChange }) => {
        const [isEditing, setIsEditing] = useState(false);
        const [tempDate, setTempDate] = useState(date);

        useEffect(() => {
            setTempDate(date);
        }, [date]);

        const handleBlur = () => {
            setIsEditing(false);
            if (tempDate !== date) {
                onChange(tempDate);
            }
        };

        if (isEditing) {
            return (
                <input 
                    type="date" 
                    value={tempDate || ''} 
                    onChange={(e) => setTempDate(e.target.value)}
                    onBlur={handleBlur}
                    onKeyDown={(e) => e.key === 'Enter' && handleBlur()}
                    className="text-xs bg-white border border-indigo-300 rounded px-1 py-0.5 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    autoFocus
                />
            );
        }

        return (
            <div 
                onClick={() => setIsEditing(true)}
                className="flex items-center text-gray-600 bg-gray-100 hover:bg-gray-200 px-2.5 py-1 rounded-md inline-flex cursor-pointer transition-colors"
                title="Click to edit deadline"
            >
                <Icons.Calendar />
                <span className="ml-2 font-medium">
                    {date ? new Date(date).toLocaleDateString(undefined, {month:'short', day:'numeric'}) : "Set Date"}
                </span>
            </div>
        );
    };

    // --- Application Table Component ---
    const AppTable = ({ apps, onUpdate, onDelete }) => {
        const statusColors = {
            'Not Started': 'bg-gray-100 text-gray-600',
            'In Progress': 'bg-blue-50 text-blue-600',
            'Submitted': 'bg-purple-50 text-purple-600',
            'Decision': 'bg-emerald-50 text-emerald-600',
        };

        return (
            <div className="overflow-x-auto bg-white rounded-xl shadow-sm border border-gray-200">
                <table className="w-full text-sm text-left">
                    <thead className="bg-gray-50 text-gray-500 font-semibold border-b border-gray-200">
                        <tr>
                            <th className="px-6 py-4 w-1/4">University</th>
                            <th className="px-6 py-4">Deadline</th>
                            <th className="px-6 py-4 w-1/3">Checklist</th>
                            <th className="px-6 py-4">Status</th>
                            <th className="px-6 py-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                        {apps.map(app => {
                            return (
                                <tr key={app.id} className="hover:bg-gray-50/50 transition-colors align-top">
                                    <td className="px-6 py-4">
                                        <div className="font-medium text-gray-900 text-base">{app.university}</div>
                                        <div className="text-xs text-gray-500 font-medium">{app.program}</div>
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap">
                                        <EditableDate 
                                            date={app.deadline} 
                                            onChange={(newDate) => onUpdate(app.id, { ...app, deadline: newDate })} 
                                        />
                                    </td>
                                    <td className="px-6 py-4">
                                        <div className="flex flex-wrap gap-2">
                                            {app.checklist.map(item => (
                                                <div 
                                                    key={item.id}
                                                    onClick={() => {
                                                        const newChecklist = app.checklist.map(i => 
                                                            i.id === item.id ? { ...i, completed: !i.completed } : i
                                                        );
                                                        onUpdate(app.id, { ...app, checklist: newChecklist });
                                                    }}
                                                    className={`flex items-center gap-1.5 px-2 py-1 rounded border cursor-pointer transition-all ${
                                                        item.completed 
                                                        ? 'bg-emerald-50 border-emerald-200 text-emerald-700' 
                                                        : 'bg-white border-gray-200 text-gray-500 hover:border-gray-300'
                                                    }`}
                                                    title={item.text}
                                                >
                                                    <div className="scale-75">
                                                        {item.completed ? <Icons.CheckSquare /> : <Icons.Square />}
                                                    </div>
                                                    <span className={`text-xs whitespace-nowrap ${item.completed ? 'line-through opacity-75' : ''}`}>
                                                        {item.text}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    </td>
                                    <td className="px-6 py-4">
                                        <select 
                                            value={app.status}
                                            onChange={(e) => onUpdate(app.id, { ...app, status: e.target.value })}
                                            className={`text-xs font-semibold px-3 py-1.5 rounded-full appearance-none cursor-pointer outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 border-transparent ${statusColors[app.status] || statusColors['Not Started']}`}
                                        >
                                            <option value="Not Started">Not Started</option>
                                            <option value="In Progress">In Progress</option>
                                            <option value="Submitted">Submitted</option>
                                            <option value="Decision">Decision</option>
                                        </select>
                                    </td>
                                    <td className="px-6 py-4 text-right">
                                        <button onClick={() => onDelete(app.id)} className="text-gray-300 hover:text-red-500 transition-colors p-2 rounded-full hover:bg-red-50">
                                            <Icons.Trash2 />
                                        </button>
                                    </td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>
        );
    };

    // --- Application Card Component ---
    const AppCard = ({ app, onUpdate, onDelete }) => {
        const [newProfName, setNewProfName] = useState("");
        const [newProfEmail, setNewProfEmail] = useState("");
        const [showAddProf, setShowAddProf] = useState(false);
        const [newChecklistItem, setNewChecklistItem] = useState("");
        const [showAddChecklist, setShowAddChecklist] = useState(false);
        const [expanded, setExpanded] = useState(false);

        const statusColors = {
            'Not Started': 'bg-gray-100 text-gray-600 border-gray-200',
            'In Progress': 'bg-blue-50 text-blue-600 border-blue-200',
            'Submitted': 'bg-purple-50 text-purple-600 border-purple-200',
            'Decision': 'bg-emerald-50 text-emerald-600 border-emerald-200',
        };

        const completedItems = app.checklist.filter(i => i.completed).length;
        const totalItems = app.checklist.length;
        const progress = totalItems === 0 ? 0 : Math.round((completedItems / totalItems) * 100);

        const handleAddProf = () => {
            if (!newProfName) return;
            const updatedProfs = [...(app.professors || []), { 
                id: Date.now(), 
                name: newProfName, 
                email: newProfEmail, 
                emailed: false 
            }];
            onUpdate(app.id, { ...app, professors: updatedProfs });
            setNewProfName("");
            setNewProfEmail("");
            setShowAddProf(false);
        };

        const handleAddChecklistItem = (e) => {
            if (e.key === 'Enter' && newChecklistItem.trim()) {
                const newItem = {
                    id: Date.now(),
                    text: newChecklistItem,
                    completed: false
                };
                onUpdate(app.id, { ...app, checklist: [...app.checklist, newItem] });
                setNewChecklistItem("");
                setShowAddChecklist(false);
            }
        };

        const removeChecklistItem = (itemId) => {
            onUpdate(app.id, { 
                ...app, 
                checklist: app.checklist.filter(i => i.id !== itemId) 
            });
        };

        const toggleProfEmail = (profId) => {
            const updatedProfs = app.professors.map(p => 
                p.id === profId ? { ...p, emailed: !p.emailed } : p
            );
            onUpdate(app.id, { ...app, professors: updatedProfs });
        };

        const deleteProf = (profId) => {
            const updatedProfs = app.professors.filter(p => p.id !== profId);
            onUpdate(app.id, { ...app, professors: updatedProfs });
        };

        const toggleChecklist = (itemId) => {
            const newChecklist = app.checklist.map(i => 
                i.id === itemId ? { ...i, completed: !i.completed } : i
            );
            onUpdate(app.id, { ...app, checklist: newChecklist });
        };

        const handleStatusChange = (e) => {
             onUpdate(app.id, { ...app, status: e.target.value });
        }

        const searchDeadline = () => {
            const query = encodeURIComponent(`${app.university} ${app.program} application deadline 2025`);
            window.open(`https://www.google.com/search?q=${query}`, '_blank');
        };

        return (
            <div className="group bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all duration-200 overflow-hidden flex flex-col">
                <div className="p-5">
                    <div className="flex justify-between items-start mb-2">
                        <div className="flex-1 min-w-0 pr-2">
                            <h3 className="font-bold text-gray-900 text-lg leading-tight truncate" title={app.university}>{app.university}</h3>
                            <p className="text-sm text-gray-500 font-medium truncate">{app.program}</p>
                        </div>
                        <select 
                            value={app.status} 
                            onChange={handleStatusChange}
                            className={`text-xs font-semibold px-2.5 py-1 rounded-full border appearance-none cursor-pointer outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 ${statusColors[app.status] || statusColors['Not Started']}`}
                        >
                            <option value="Not Started">Not Started</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Submitted">Submitted</option>
                            <option value="Decision">Decision</option>
                        </select>
                    </div>
                    
                    <div className="flex items-center gap-4 text-sm mt-3">
                        <EditableDate 
                            date={app.deadline} 
                            onChange={(newDate) => onUpdate(app.id, { ...app, deadline: newDate })} 
                        />
                        {!app.deadline && <button onClick={searchDeadline} className="text-indigo-600 hover:text-indigo-700"><Icons.Search /></button>}
                         <div className="flex items-center gap-2 flex-1">
                             <div className="h-1.5 w-full bg-gray-100 rounded-full overflow-hidden">
                                <div className="h-full bg-indigo-500 rounded-full transition-all duration-500" style={{ width: `${progress}%` }}></div>
                             </div>
                             <span className="text-xs text-gray-400 w-8 text-right">{progress}%</span>
                         </div>
                    </div>

                    <button 
                        onClick={() => setExpanded(!expanded)}
                        className="w-full mt-4 flex items-center justify-center gap-1 text-xs font-medium text-gray-400 hover:text-gray-600 transition-colors py-1" 
                    >
                        {expanded ? "Collapse Details" : "View Details & Professors"}
                        <div className={`transform transition-transform duration-200 ${expanded ? "rotate-180" : ""}`}>
                            <Icons.ChevronDown />
                        </div>
                    </button>
                </div>

                {expanded && (
                    <div className="border-t border-gray-100 bg-gray-50/50 p-5 space-y-5 animate-in slide-in-from-top-2 duration-200">
                        <div>
                            <div className="flex justify-between items-center mb-2">
                                <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider">Application Checklist</h4>
                                <button 
                                    onClick={() => setShowAddChecklist(!showAddChecklist)}
                                    className="text-xs text-indigo-600 hover:text-indigo-800 font-medium"
                                >+ Add Item</button>
                            </div>
                            
                            <div className="grid grid-cols-1 gap-1.5">
                                {app.checklist.map(item => (
                                    <div 
                                        key={item.id} 
                                        className="flex items-center gap-3 text-sm text-gray-600 group/check p-1 hover:bg-white rounded transition-colors relative"
                                    >
                                        <div onClick={() => toggleChecklist(item.id)} className="flex items-center gap-3 cursor-pointer flex-1">
                                            {item.completed 
                                                ? <div className="text-emerald-500"><Icons.CheckSquare /></div>
                                                : <div className="text-gray-300 group-hover/check:text-gray-400"><Icons.Square /></div>
                                            }
                                            <span className={item.completed ? "line-through opacity-50" : ""}>{item.text}</span>
                                        </div>
                                        <button 
                                            onClick={() => removeChecklistItem(item.id)}
                                            className="opacity-0 group-hover/check:opacity-100 text-gray-300 hover:text-red-400 transition-opacity p-1"
                                        >
                                            <Icons.X />
                                        </button>
                                    </div>
                                ))}
                                {showAddChecklist && (
                                    <input 
                                        type="text"
                                        autoFocus
                                        className="w-full text-sm border border-gray-200 rounded px-2 py-1 focus:outline-none focus:border-indigo-500"
                                        placeholder="Type and press Enter..."
                                        value={newChecklistItem}
                                        onChange={e => setNewChecklistItem(e.target.value)}
                                        onKeyDown={handleAddChecklistItem}
                                        onBlur={() => setShowAddChecklist(false)}
                                    />
                                )}
                            </div>
                        </div>

                        <div>
                            <div className="flex justify-between items-center mb-2">
                                <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider">Professors</h4>
                                <button 
                                    onClick={() => setShowAddProf(!showAddProf)}
                                    className="text-xs text-indigo-600 hover:text-indigo-800 font-medium"
                                >+ Add</button>
                            </div>
                            
                            {showAddProf && (
                                <div className="mb-3 p-2 bg-white rounded-md border border-gray-200 shadow-sm">
                                    <input
                                        className="w-full text-sm p-1.5 border-b border-gray-100 focus:outline-none focus:border-indigo-500 mb-2"
                                        placeholder="Name"
                                        value={newProfName}
                                        onChange={e => setNewProfName(e.target.value)}
                                    />
                                    <input
                                        className="w-full text-sm p-1.5 border-b border-gray-100 focus:outline-none focus:border-indigo-500 mb-2"
                                        placeholder="Email"
                                        value={newProfEmail}
                                        onChange={e => setNewProfEmail(e.target.value)}
                                    />
                                    <div className="flex justify-end gap-2 mt-2">
                                        <button onClick={() => setShowAddProf(false)} className="text-xs text-gray-400 hover:text-gray-600">Cancel</button>
                                        <button onClick={handleAddProf} className="text-xs bg-gray-900 text-white px-2 py-1 rounded hover:bg-black">Save</button>
                                    </div>
                                </div>
                            )}

                            <div className="space-y-2">
                                {(app.professors || []).length === 0 && !showAddProf && <p className="text-xs text-gray-400 italic">No professors listed.</p>}
                                {(app.professors || []).map(prof => (
                                    <div key={prof.id} className="flex items-center justify-between bg-white p-2 rounded border border-gray-100">
                                        <div className="flex items-center gap-3 overflow-hidden">
                                            <button 
                                                onClick={() => toggleProfEmail(prof.id)}
                                                className={`p-1.5 rounded-full transition-colors ${prof.emailed ? "bg-indigo-100 text-indigo-600" : "bg-gray-100 text-gray-400 hover:bg-gray-200"}`}
                                                title={prof.emailed ? "Mark as not emailed" : "Mark as emailed"}
                                            >
                                                <Icons.Mail />
                                            </button>
                                            <div className="truncate">
                                                <div className={`text-sm font-medium ${prof.emailed ? "text-gray-500 line-through" : "text-gray-700"}`}>{prof.name}</div>
                                                {prof.email && <div className="text-xs text-gray-400 truncate">{prof.email}</div>}
                                            </div>
                                        </div>
                                        <button onClick={() => deleteProf(prof.id)} className="text-gray-300 hover:text-red-500 ml-2">
                                            <Icons.Trash2 />
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="flex justify-end pt-2 border-t border-gray-100">
                            <button onClick={() => onDelete(app.id)} className="text-xs text-red-400 hover:text-red-600 flex items-center gap-1">
                                <Icons.Trash2 /> Remove
                            </button>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    // --- Main App Component ---
    const App = () => {
        const [apps, setApps] = useState([]);
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [filterStatus, setFilterStatus] = useState("All");
        const [sortBy, setSortBy] = useState("deadline"); // deadline, progress, name
        
        // Form State
        const [uniName, setUniName] = useState("");
        const [programName, setProgramName] = useState("");
        const [deadline, setDeadline] = useState("");

        // Load data on mount
        useEffect(() => {
            const storedApps = loadData();
            setApps(storedApps);
        }, []);

        // Helper to update state and localStorage
        const updateAppsState = (newApps) => {
            setApps(newApps);
            saveData(newApps);
        };

        const handleAddApp = () => {
            if (!uniName || !programName) return;
            
            const newApp = {
                id: Date.now(),
                university: uniName,
                program: programName,
                deadline: deadline || null,
                status: "Not Started",
                professors: [],
                checklist: [...DefaultChecklist],
                createdAt: new Date()
            };

            updateAppsState([...apps, newApp]);
            setUniName("");
            setProgramName("");
            setDeadline("");
            setIsModalOpen(false);
        };

        const updateApp = (id, updatedApp) => {
            const newApps = apps.map(app => app.id === id ? updatedApp : app);
            updateAppsState(newApps);
        };

        const deleteApp = (id) => {
            if(confirm("Are you sure you want to delete this application?")) {
                const newApps = apps.filter(app => app.id !== id);
                updateAppsState(newApps);
            }
        };

        const searchDeadlineForForm = () => {
             if(!uniName) return;
             const query = encodeURIComponent(`${uniName} ${programName} application deadline 2025`);
             window.open(`https://www.google.com/search?q=${query}`, '_blank');
        }

        const exportData = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(apps));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "gradtrack_backup.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        };

        const importData = (event) => {
            const fileObj = event.target.files[0];
            if (!fileObj) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    if(Array.isArray(json)) {
                        updateAppsState(json);
                        alert("Data imported successfully!");
                    }
                } catch(err) {
                    alert("Invalid JSON file");
                }
            };
            reader.readAsText(fileObj);
        };

        const filteredApps = useMemo(() => {
            let sorted = [...apps];
            
            if (sortBy === "deadline") {
                sorted.sort((a, b) => {
                    if (!a.deadline) return 1;
                    if (!b.deadline) return -1;
                    return new Date(a.deadline) - new Date(b.deadline);
                });
            } else if (sortBy === "name") {
                sorted.sort((a, b) => a.university.localeCompare(b.university));
            } else if (sortBy === "progress") {
                sorted.sort((a, b) => {
                    const progressA = a.checklist.length ? a.checklist.filter(i => i.completed).length / a.checklist.length : 0;
                    const progressB = b.checklist.length ? b.checklist.filter(i => i.completed).length / b.checklist.length : 0;
                    return progressB - progressA; // High to low
                });
            }

            if (filterStatus === "All") return sorted;
            return sorted.filter(a => a.status === filterStatus);
        }, [apps, filterStatus, sortBy]);

        return (
            <div className="min-h-screen text-gray-800 pb-20">
                <nav className="sticky top-0 z-30 glass-panel border-b border-gray-200">
                    <div className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                        <div className="flex items-center gap-2">
                             <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold shadow-lg shadow-indigo-200">G</div>
                             <span className="font-bold text-xl tracking-tight text-gray-900">GradTrack</span>
                        </div>
                        <div className="flex items-center gap-3">
                             <label className="cursor-pointer text-gray-400 hover:text-gray-600 transition-colors p-2" title="Import Data">
                                <input type="file" className="hidden" onChange={importData} accept=".json" />
                                <Icons.Upload />
                             </label>
                             <button onClick={exportData} className="text-gray-400 hover:text-gray-600 transition-colors p-2" title="Export Data">
                                <Icons.Download />
                             </button>
                             <button 
                                onClick={() => setIsModalOpen(true)}
                                className="bg-gray-900 hover:bg-black text-white px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 shadow-xl shadow-gray-200"
                            >
                                <Icons.Plus /> <span className="hidden sm:inline">Add Application</span>
                            </button>
                        </div>
                    </div>
                </nav>

                <main className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
                        <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide w-full sm:w-auto">
                            {["All", "Not Started", "In Progress", "Submitted", "Decision"].map(status => (
                                <button
                                    key={status}
                                    onClick={() => setFilterStatus(status)}
                                    className={`px-4 py-1.5 rounded-full text-sm font-medium transition-colors whitespace-nowrap ${
                                        filterStatus === status 
                                        ? "bg-gray-900 text-white shadow-lg shadow-gray-200" 
                                        : "bg-white text-gray-500 hover:bg-gray-50 border border-gray-200"
                                    }`}
                                >
                                    {status}
                                </button>
                            ))}
                        </div>
                        
                        <div className="flex items-center gap-2 text-sm text-gray-500 bg-white px-3 py-1.5 rounded-full border border-gray-200 shadow-sm">
                            <Icons.SortAsc />
                            <span className="hidden sm:inline">Sort by:</span>
                            <select 
                                value={sortBy} 
                                onChange={(e) => setSortBy(e.target.value)}
                                className="bg-transparent outline-none font-medium text-gray-700 cursor-pointer"
                            >
                                <option value="deadline">Deadline</option>
                                <option value="progress">Progress</option>
                                <option value="name">Name (A-Z)</option>
                            </select>
                        </div>
                    </div>

                    {apps.length === 0 ? (
                        <div className="text-center py-20">
                            <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <div className="text-gray-400"><Icons.Calendar /></div>
                            </div>
                            <h3 className="text-gray-900 font-semibold text-lg">No applications yet</h3>
                            <p className="text-gray-500 mt-1 max-w-xs mx-auto">Start by adding your dream universities.</p>
                            <button onClick={() => setIsModalOpen(true)} className="mt-6 text-indigo-600 font-medium hover:underline">Add your first application</button>
                        </div>
                    ) : (
                        <>
                            {filterStatus === "All" ? (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {filteredApps.map(app => (
                                        <AppCard key={app.id} app={app} onUpdate={updateApp} onDelete={deleteApp} />
                                    ))}
                                </div>
                            ) : (
                                filteredApps.length > 0 ? (
                                    <AppTable apps={filteredApps} onUpdate={updateApp} onDelete={deleteApp} />
                                ) : (
                                    <div className="text-center py-12 border-2 border-dashed border-gray-200 rounded-xl">
                                        <p className="text-gray-500">No applications in "{filterStatus}" status.</p>
                                    </div>
                                )
                            )}
                        </>
                    )}
                </main>
                
                <DailyToDo />

                <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="New Application">
                    <div className="space-y-4">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">University</label>
                            <input 
                                value={uniName}
                                onChange={e => setUniName(e.target.value)}
                                className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-all"
                                placeholder="e.g. Stanford University"
                            />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Program / Major</label>
                            <input 
                                value={programName}
                                onChange={e => setProgramName(e.target.value)}
                                className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-all"
                                placeholder="e.g. MS in Computer Science"
                            />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Application Deadline</label>
                            <div className="flex gap-2">
                                <input 
                                    type="date"
                                    value={deadline}
                                    onChange={e => setDeadline(e.target.value)}
                                    className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-all"
                                />
                                <button
                                    onClick={searchDeadlineForForm}
                                    title="Search for deadline on Google"
                                    className="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 rounded-lg border border-gray-200 transition-colors"
                                >
                                    <Icons.Search />
                                </button>
                            </div>
                             <p className="text-[10px] text-gray-400 mt-1.5">Tip: Use the search button if you don't know the deadline.</p>
                        </div>
                        <div className="pt-4 flex justify-end gap-3">
                             <button onClick={() => setIsModalOpen(false)} className="text-gray-500 text-sm hover:text-gray-700 font-medium px-3 py-2">Cancel</button>
                             <button 
                                onClick={handleAddApp}
                                disabled={!uniName || !programName}
                                className="bg-gray-900 hover:bg-black disabled:opacity-50 disabled:cursor-not-allowed text-white text-sm font-medium px-5 py-2 rounded-lg shadow-lg shadow-gray-200 transition-all" 
                            >
                                Create Tracker
                            </button>
                        </div>
                    </div>
                </Modal>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
