import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  updateDoc, 
  deleteDoc, 
  doc, 
  onSnapshot, 
  writeBatch,
  query,
  orderBy
} from 'firebase/firestore';
import { 
  Package, 
  FlaskConical, 
  Factory, 
  ShoppingCart, 
  Plus, 
  Trash2, 
  Save, 
  AlertCircle,
  CheckCircle2,
  LayoutDashboard,
  Boxes,
  Users,
  FileText,
  DollarSign,
  Printer,
  ArrowLeft,
  Search
} from 'lucide-react';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Utilities ---
const formatCurrency = (amount) => {
  return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount || 0);
};

const formatDate = (isoString) => {
  if (!isoString) return '';
  return new Date(isoString).toLocaleDateString();
};

// --- Components ---

const LoadingScreen = () => (
  <div className="flex items-center justify-center h-screen bg-slate-50 text-slate-600 font-medium">
    <div className="flex flex-col items-center gap-4">
      <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
      <p>Initializing MaterialMaster Systems...</p>
    </div>
  </div>
);

const Button = ({ children, onClick, variant = 'primary', disabled = false, className = '', icon: Icon }) => {
  const baseStyle = "flex items-center justify-center px-4 py-2 rounded-lg font-medium transition-all focus:outline-none focus:ring-2 focus:ring-offset-1 disabled:opacity-50 disabled:cursor-not-allowed print:hidden";
  const variants = {
    primary: "bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-indigo-500",
    secondary: "bg-white text-slate-700 border border-slate-300 hover:bg-slate-50 focus:ring-slate-400",
    danger: "bg-red-50 text-red-600 border border-red-200 hover:bg-red-100 focus:ring-red-500",
    success: "bg-emerald-600 text-white hover:bg-emerald-700 focus:ring-emerald-500",
    ghost: "bg-transparent text-slate-600 hover:bg-slate-100 focus:ring-slate-300"
  };

  return (
    <button 
      onClick={onClick} 
      disabled={disabled} 
      className={`${baseStyle} ${variants[variant]} ${className}`}
    >
      {Icon && <Icon size={18} className="mr-2" />}
      {children}
    </button>
  );
};

const Card = ({ title, children, action, className = '' }) => (
  <div className={`bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden print:shadow-none print:border-0 ${className}`}>
    <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 print:hidden">
      <h3 className="font-semibold text-slate-800">{title}</h3>
      {action}
    </div>
    <div className="p-6 print:p-0">
      {children}
    </div>
  </div>
);

// --- Main Application ---

export default function MaterialMaster() {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('dashboard');
  
  // Data State
  const [materials, setMaterials] = useState([]);
  const [products, setProducts] = useState([]);
  const [contacts, setContacts] = useState([]);
  const [transactions, setTransactions] = useState([]);
  const [invoices, setInvoices] = useState([]);
  
  // Form States
  const [newMaterial, setNewMaterial] = useState({ name: '', unit: 'kg', stock: 0, cost: 0 });
  const [newProduct, setNewProduct] = useState({ name: '', ingredients: [], sellingPrice: 0, stock: 0 });
  const [productionTarget, setProductionTarget] = useState({ productId: '', quantity: 1 });
  const [newContact, setNewContact] = useState({ name: '', type: 'buyer', address: '', contactPerson: '', phone: '' });
  
  // UI States
  const [isAddingMaterial, setIsAddingMaterial] = useState(false);
  const [isAddingProduct, setIsAddingProduct] = useState(false);
  const [isAddingContact, setIsAddingContact] = useState(false);
  const [loading, setLoading] = useState(true);

  // --- Auth & Init ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth failed:", error);
      }
    };
    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      if (currentUser) setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // --- Data Fetching ---
  useEffect(() => {
    if (!user) return;

    const collections = ['materials', 'products', 'contacts', 'transactions', 'invoices'];
    const unsubscribes = collections.map(colName => {
      return onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', colName), 
        (snapshot) => {
          const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          if (colName === 'materials') setMaterials(data);
          if (colName === 'products') setProducts(data);
          if (colName === 'contacts') setContacts(data);
          if (colName === 'transactions') setTransactions(data.sort((a,b) => new Date(b.date) - new Date(a.date)));
          if (colName === 'invoices') setInvoices(data.sort((a,b) => new Date(b.date) - new Date(a.date)));
        },
        (err) => console.error(`${colName} error:`, err)
      );
    });

    return () => unsubscribes.forEach(unsub => unsub());
  }, [user]);

  // --- Actions ---

  // Materials
  const handleAddMaterial = async () => {
    if (!newMaterial.name) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'materials'), {
        ...newMaterial,
        stock: Number(newMaterial.stock),
        cost: Number(newMaterial.cost),
        createdAt: new Date().toISOString()
      });
      setNewMaterial({ name: '', unit: 'kg', stock: 0, cost: 0 });
      setIsAddingMaterial(false);
    } catch (e) { console.error(e); }
  };

  const handleUpdateMaterial = async (id, field, value) => {
    try {
      await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'materials', id), { [field]: value });
    } catch(e) { console.error(e); }
  };

  const handleDeleteMaterial = async (id) => {
    if (!confirm('Delete this material?')) return;
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'materials', id));
  };

  // Products
  const handleAddProduct = async () => {
    if (!newProduct.name || newProduct.ingredients.length === 0) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), {
        ...newProduct,
        sellingPrice: Number(newProduct.sellingPrice),
        stock: 0,
        createdAt: new Date().toISOString()
      });
      setNewProduct({ name: '', ingredients: [], sellingPrice: 0, stock: 0 });
      setIsAddingProduct(false);
    } catch (e) { console.error(e); }
  };

  const handleDeleteProduct = async (id) => {
    if (!confirm('Delete this product?')) return;
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id));
  };

  // Contacts
  const handleAddContact = async () => {
    if (!newContact.name) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'contacts'), {
        ...newContact,
        createdAt: new Date().toISOString()
      });
      setNewContact({ name: '', type: 'buyer', address: '', contactPerson: '', phone: '' });
      setIsAddingContact(false);
    } catch(e) { console.error(e); }
  };

  const handleDeleteContact = async (id) => {
    if(!confirm('Delete contact?')) return;
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'contacts', id));
  };

  // Production
  const executeProduction = async () => {
    const product = products.find(p => p.id === productionTarget.productId);
    if (!product) return;

    const qty = Number(productionTarget.quantity);
    if (qty <= 0) return;

    // Check stock
    const insufficient = product.ingredients.some(ing => {
      const mat = materials.find(m => m.id === ing.materialId);
      return !mat || mat.stock < (ing.qty * qty);
    });

    if (insufficient) {
      alert("Insufficient stock to produce this batch.");
      return;
    }

    const batch = writeBatch(db);
    
    // Deduct Materials
    product.ingredients.forEach(ing => {
      const mat = materials.find(m => m.id === ing.materialId);
      if (mat) {
        const matRef = doc(db, 'artifacts', appId, 'public', 'data', 'materials', mat.id);
        const newStock = Number(mat.stock) - (Number(ing.qty) * qty);
        batch.update(matRef, { stock: newStock });
      }
    });

    // Increment Product Stock
    const prodRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', product.id);
    batch.update(prodRef, { stock: (product.stock || 0) + qty });

    try {
      await batch.commit();
      alert(`Produced ${qty} units of ${product.name}`);
      setProductionTarget({ ...productionTarget, quantity: 1 });
    } catch (e) {
      console.error(e);
      alert("Production failed.");
    }
  };

  // --- Views ---

  const DashboardView = () => {
    const totalMaterialValue = materials.reduce((acc, m) => acc + (m.stock * m.cost), 0);
    const totalProductValue = products.reduce((acc, p) => acc + ((p.stock || 0) * p.sellingPrice), 0);
    const lowStockMaterials = materials.filter(m => m.stock < 10);
    
    // Financial Summary
    const totalIncome = transactions.filter(t => t.type === 'income').reduce((acc, t) => acc + t.amount, 0);
    const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((acc, t) => acc + t.amount, 0);
    const netProfit = totalIncome - totalExpenses;

    return (
      <div className="space-y-6">
        <h2 className="text-2xl font-bold text-slate-800">Dashboard</h2>
        
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <Card title="Net Profit" className={netProfit >= 0 ? "border-l-4 border-l-emerald-500" : "border-l-4 border-l-red-500"}>
            <div className={`text-3xl font-bold ${netProfit >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
              {formatCurrency(netProfit)}
            </div>
            <p className="text-sm text-slate-500 mt-1">Total Income - Expenses</p>
          </Card>

          <Card title="Inventory Value" className="border-l-4 border-l-indigo-500">
            <div className="text-3xl font-bold text-slate-800">{formatCurrency(totalMaterialValue + totalProductValue)}</div>
            <p className="text-sm text-slate-500 mt-1">Materials + Products</p>
          </Card>

           <Card title="Expenses" className="border-l-4 border-l-orange-500">
            <div className="text-3xl font-bold text-slate-800">{formatCurrency(totalExpenses)}</div>
            <p className="text-sm text-slate-500 mt-1">Total Material Cost</p>
          </Card>

          <Card title="Sales" className="border-l-4 border-l-blue-500">
            <div className="text-3xl font-bold text-slate-800">{formatCurrency(totalIncome)}</div>
            <p className="text-sm text-slate-500 mt-1">Total Invoiced</p>
          </Card>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <Card title="Low Stock Alerts">
            {lowStockMaterials.length > 0 ? (
              <ul className="divide-y divide-slate-100">
                {lowStockMaterials.map(m => (
                  <li key={m.id} className="py-3 flex justify-between items-center">
                    <span className="font-medium text-slate-700">{m.name}</span>
                    <span className="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold">{m.stock} {m.unit}</span>
                  </li>
                ))}
              </ul>
            ) : (
              <p className="text-slate-400 italic">All stock levels healthy.</p>
            )}
          </Card>

          <Card title="Recent Transactions">
            <ul className="divide-y divide-slate-100">
              {transactions.slice(0, 5).map(t => (
                <li key={t.id} className="py-3 flex justify-between items-center">
                  <div>
                    <p className="font-medium text-slate-800">{t.description}</p>
                    <p className="text-xs text-slate-400">{formatDate(t.date)}</p>
                  </div>
                  <span className={`font-mono font-bold ${t.type === 'income' ? 'text-emerald-600' : 'text-red-600'}`}>
                    {t.type === 'income' ? '+' : '-'}{formatCurrency(t.amount)}
                  </span>
                </li>
              ))}
              {transactions.length === 0 && <p className="text-slate-400 italic">No transactions recorded.</p>}
            </ul>
          </Card>
        </div>
      </div>
    );
  };

  const InventoryView = () => (
    <div className="space-y-6">
      <div className="flex justify-between items-end">
        <div>
          <h2 className="text-2xl font-bold text-slate-800">Raw Materials</h2>
          <p className="text-slate-500">Inventory and Cost Management</p>
        </div>
        <Button onClick={() => setIsAddingMaterial(true)} icon={Plus}>Add Material</Button>
      </div>

      {isAddingMaterial && (
        <Card title="New Material" action={<Button variant="secondary" onClick={() => setIsAddingMaterial(false)} className="!py-1 !px-2 text-sm">Cancel</Button>}>
          <div className="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
            <div className="md:col-span-2">
              <label className="block text-sm font-medium text-slate-700 mb-1">Name</label>
              <input type="text" className="w-full border p-2 rounded" value={newMaterial.name} onChange={e => setNewMaterial({...newMaterial, name: e.target.value})} placeholder="Steel Sheet" />
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1">Unit</label>
              <select className="w-full border p-2 rounded" value={newMaterial.unit} onChange={e => setNewMaterial({...newMaterial, unit: e.target.value})}>
                {['kg', 'g', 'l', 'ml', 'pcs', 'm', 'ft'].map(u => <option key={u} value={u}>{u}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1">Cost/Unit</label>
              <input type="number" className="w-full border p-2 rounded" value={newMaterial.cost} onChange={e => setNewMaterial({...newMaterial, cost: e.target.value})} />
            </div>
             <div>
              <label className="block text-sm font-medium text-slate-700 mb-1">Stock</label>
              <input type="number" className="w-full border p-2 rounded" value={newMaterial.stock} onChange={e => setNewMaterial({...newMaterial, stock: e.target.value})} />
            </div>
            <Button onClick={handleAddMaterial} icon={Save} className="md:col-span-5">Save Material</Button>
          </div>
        </Card>
      )}

      <div className="bg-white rounded-xl shadow border overflow-hidden">
        <table className="w-full text-left">
          <thead className="bg-slate-50 border-b text-slate-600">
            <tr>
              <th className="p-4">Name</th>
              <th className="p-4">Stock</th>
              <th className="p-4">Unit Cost</th>
              <th className="p-4">Total Value</th>
              <th className="p-4 text-right">Actions</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {materials.map(mat => (
              <tr key={mat.id} className="hover:bg-slate-50">
                <td className="p-4 font-medium">{mat.name}</td>
                <td className="p-4">
                  <span className={`px-2 py-1 rounded text-sm font-bold ${mat.stock < 10 ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-700'}`}>
                    {mat.stock} {mat.unit}
                  </span>
                </td>
                <td className="p-4">
                  <div className="flex items-center gap-1">
                    <span className="text-slate-400">$</span>
                    <input 
                      type="number" 
                      className="w-20 bg-transparent border-b border-dashed border-slate-300 focus:border-indigo-500 outline-none"
                      value={mat.cost} 
                      onChange={(e) => handleUpdateMaterial(mat.id, 'cost', Number(e.target.value))}
                    />
                  </div>
                </td>
                <td className="p-4 text-slate-500 font-mono">{formatCurrency(mat.stock * mat.cost)}</td>
                <td className="p-4 text-right">
                  <button onClick={() => handleDeleteMaterial(mat.id)} className="text-slate-400 hover:text-red-600"><Trash2 size={18}/></button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );

  const ContactsView = () => (
    <div className="space-y-6">
      <div className="flex justify-between items-end">
        <div>
          <h2 className="text-2xl font-bold text-slate-800">Contacts</h2>
          <p className="text-slate-500">Manage Buyers and Sellers</p>
        </div>
        <Button onClick={() => setIsAddingContact(true)} icon={Plus}>Add Contact</Button>
      </div>

      {isAddingContact && (
        <Card title="New Contact" action={<Button variant="secondary" onClick={() => setIsAddingContact(false)} className="!py-1 !px-2 text-sm">Cancel</Button>}>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label className="text-sm font-medium block mb-1">Name/Company</label><input className="border p-2 rounded w-full" value={newContact.name} onChange={e => setNewContact({...newContact, name: e.target.value})} placeholder="Acme Corp" /></div>
            <div>
                <label className="text-sm font-medium block mb-1">Type</label>
                <select className="border p-2 rounded w-full" value={newContact.type} onChange={e => setNewContact({...newContact, type: e.target.value})}>
                    <option value="buyer">Buyer</option>
                    <option value="seller">Seller</option>
                    <option value="both">Both</option>
                </select>
            </div>
            <div><label className="text-sm font-medium block mb-1">Contact Person</label><input className="border p-2 rounded w-full" value={newContact.contactPerson} onChange={e => setNewContact({...newContact, contactPerson: e.target.value})} placeholder="John Doe" /></div>
            <div><label className="text-sm font-medium block mb-1">Phone</label><input className="border p-2 rounded w-full" value={newContact.phone} onChange={e => setNewContact({...newContact, phone: e.target.value})} placeholder="+1 234..." /></div>
            <div className="md:col-span-2"><label className="text-sm font-medium block mb-1">Address</label><input className="border p-2 rounded w-full" value={newContact.address} onChange={e => setNewContact({...newContact, address: e.target.value})} placeholder="123 Business Rd..." /></div>
            <div className="md:col-span-2 flex justify-end"><Button onClick={handleAddContact} icon={Save}>Save Contact</Button></div>
          </div>
        </Card>
      )}

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {contacts.map(contact => (
            <Card key={contact.id} title={contact.name} action={<button onClick={() => handleDeleteContact(contact.id)} className="text-slate-400 hover:text-red-500"><Trash2 size={16}/></button>}>
                <div className="space-y-2 text-sm text-slate-600">
                    <div className="flex justify-between"><span className="text-slate-400">Type:</span> <span className="uppercase font-bold text-xs bg-slate-100 px-2 py-0.5 rounded">{contact.type}</span></div>
                    <div className="flex justify-between"><span className="text-slate-400">Person:</span> <span>{contact.contactPerson || '-'}</span></div>
                    <div className="flex justify-between"><span className="text-slate-400">Phone:</span> <span>{contact.phone || '-'}</span></div>
                    <div className="pt-2 border-t mt-2 text-xs text-slate-500">{contact.address || 'No address provided'}</div>
                </div>
            </Card>
        ))}
      </div>
    </div>
  );

  const FormulasView = () => {
    const [tempIngredient, setTempIngredient] = useState({ materialId: '', qty: 1 });

    const addIngredientToProduct = () => {
      if (!tempIngredient.materialId) return;
      const mat = materials.find(m => m.id === tempIngredient.materialId);
      setNewProduct(prev => ({
        ...prev,
        ingredients: [...prev.ingredients, { ...tempIngredient, name: mat.name, unit: mat.unit }]
      }));
      setTempIngredient({ materialId: '', qty: 1 });
    };

    return (
      <div className="space-y-6">
        <div className="flex justify-between items-end">
          <div>
            <h2 className="text-2xl font-bold text-slate-800">Products & Formulas</h2>
            <p className="text-slate-500">Define products, recipes and selling prices.</p>
          </div>
          <Button onClick={() => setIsAddingProduct(true)} icon={Plus}>Create Product</Button>
        </div>

        {isAddingProduct && (
          <Card title="New Product" action={<Button variant="secondary" onClick={() => setIsAddingProduct(false)} className="!py-1 !px-2 text-sm">Cancel</Button>}>
            <div className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                    <label className="block text-sm font-medium mb-1">Product Name</label>
                    <input className="w-full border p-2 rounded" value={newProduct.name} onChange={e => setNewProduct({...newProduct, name: e.target.value})} placeholder="Widget A" />
                </div>
                <div>
                    <label className="block text-sm font-medium mb-1">Selling Price</label>
                    <input type="number" className="w-full border p-2 rounded" value={newProduct.sellingPrice} onChange={e => setNewProduct({...newProduct, sellingPrice: e.target.value})} />
                </div>
              </div>

              <div className="p-4 bg-slate-50 rounded border">
                <h4 className="text-sm font-bold uppercase mb-2">Recipe</h4>
                <div className="flex gap-2 mb-2">
                  <select className="flex-1 border p-2 rounded" value={tempIngredient.materialId} onChange={e => setTempIngredient({...tempIngredient, materialId: e.target.value})}>
                    <option value="">Select Material...</option>
                    {materials.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                  </select>
                  <input type="number" className="w-20 border p-2 rounded" value={tempIngredient.qty} onChange={e => setTempIngredient({...tempIngredient, qty: e.target.value})} placeholder="Qty" />
                  <Button onClick={addIngredientToProduct} variant="secondary" icon={Plus}>Add</Button>
                </div>
                {newProduct.ingredients.map((ing, i) => (
                    <div key={i} className="flex justify-between bg-white p-2 rounded border mb-1 text-sm">
                        <span>{ing.qty} {ing.unit} of {ing.name}</span>
                        <button onClick={() => setNewProduct(prev => ({...prev, ingredients: prev.ingredients.filter((_, idx) => idx !== i)}))} className="text-red-500">&times;</button>
                    </div>
                ))}
              </div>
              <div className="flex justify-end"><Button onClick={handleAddProduct} icon={Save}>Save Product</Button></div>
            </div>
          </Card>
        )}

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {products.map(prod => (
                <Card key={prod.id} title={prod.name} action={<button onClick={() => handleDeleteProduct(prod.id)} className="text-slate-400 hover:text-red-600"><Trash2 size={16}/></button>}>
                    <div className="space-y-2">
                         <div className="flex justify-between items-center pb-2 border-b">
                            <span className="text-slate-500 text-sm">Selling Price</span>
                            <span className="font-bold text-emerald-600">{formatCurrency(prod.sellingPrice)}</span>
                        </div>
                         <div className="flex justify-between items-center pb-2 border-b">
                            <span className="text-slate-500 text-sm">Stock on Hand</span>
                            <span className="font-bold text-slate-800">{prod.stock || 0} units</span>
                        </div>
                        <p className="text-xs text-slate-400 uppercase font-bold mt-2">Ingredients</p>
                        <ul className="text-sm text-slate-600 space-y-1">
                            {prod.ingredients.map((ing, i) => {
                                const mat = materials.find(m => m.id === ing.materialId);
                                return <li key={i}>{ing.qty} {mat?.unit || ''} {mat?.name || 'Unknown'}</li>
                            })}
                        </ul>
                    </div>
                </Card>
            ))}
        </div>
      </div>
    );
  };

  const ProductionView = () => {
    const selectedProd = products.find(p => p.id === productionTarget.productId);

    return (
      <div className="space-y-6">
        <div><h2 className="text-2xl font-bold text-slate-800">Production</h2><p className="text-slate-500">Manufacture products. This deducts raw materials and increases product stock.</p></div>
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
             <div className="lg:col-span-1 space-y-4">
                <Card title="Start Batch">
                    <label className="block text-sm font-medium mb-1">Product</label>
                    <select className="w-full border p-2 rounded mb-3" value={productionTarget.productId} onChange={e => setProductionTarget({...productionTarget, productId: e.target.value})}>
                        <option value="">Select...</option>
                        {products.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                    </select>
                    <label className="block text-sm font-medium mb-1">Quantity</label>
                    <input type="number" className="w-full border p-2 rounded mb-4" value={productionTarget.quantity} onChange={e => setProductionTarget({...productionTarget, quantity: e.target.value})} />
                    <Button onClick={executeProduction} variant="success" icon={Factory} disabled={!selectedProd} className="w-full">Run Production</Button>
                </Card>
             </div>
             <div className="lg:col-span-2">
                 {selectedProd && (
                     <Card title="Requirements">
                         <table className="w-full text-sm text-left">
                             <thead className="bg-slate-50 text-slate-500"><tr><th className="p-2">Material</th><th className="p-2">Required</th><th className="p-2">Available</th><th className="p-2">Status</th></tr></thead>
                             <tbody>
                                 {selectedProd.ingredients.map((ing, i) => {
                                     const mat = materials.find(m => m.id === ing.materialId);
                                     const req = ing.qty * productionTarget.quantity;
                                     const avail = mat ? mat.stock : 0;
                                     return (
                                         <tr key={i} className="border-b">
                                             <td className="p-2 font-medium">{mat?.name}</td>
                                             <td className="p-2">{req} {mat?.unit}</td>
                                             <td className="p-2">{avail} {mat?.unit}</td>
                                             <td className="p-2">{avail >= req ? <span className="text-emerald-600 font-bold">OK</span> : <span className="text-red-600 font-bold">Low</span>}</td>
                                         </tr>
                                     )
                                 })}
                             </tbody>
                         </table>
                     </Card>
                 )}
             </div>
        </div>
      </div>
    );
  };

  const PurchasingView = () => {
    const [cart, setCart] = useState({});
    const [sellerId, setSellerId] = useState('');

    const commitPurchase = async () => {
        const batch = writeBatch(db);
        let totalCost = 0;
        let descItems = [];

        Object.entries(cart).forEach(([matId, qty]) => {
            if(qty > 0) {
                const mat = materials.find(m => m.id === matId);
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'materials', matId);
                batch.update(ref, { stock: Number(mat.stock) + Number(qty) });
                totalCost += (mat.cost * qty);
                descItems.push(`${qty}${mat.unit} ${mat.name}`);
            }
        });

        // Add Transaction
        const transRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'));
        batch.set(transRef, {
            type: 'expense',
            amount: totalCost,
            date: new Date().toISOString(),
            description: `Restock from ${contacts.find(c => c.id === sellerId)?.name || 'Unknown'}: ${descItems.join(', ')}`,
            relatedId: sellerId
        });

        await batch.commit();
        setCart({});
        alert("Stock received & Expense logged.");
    };

    return (
        <div className="space-y-6">
            <h2 className="text-2xl font-bold text-slate-800">Purchasing</h2>
            <div className="flex items-center gap-4 bg-white p-4 rounded-xl border">
                <span className="font-medium text-slate-700">Seller:</span>
                <select className="border p-2 rounded flex-1" value={sellerId} onChange={e => setSellerId(e.target.value)}>
                    <option value="">Select Seller (Optional)...</option>
                    {contacts.filter(c => c.type !== 'buyer').map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                </select>
                {Object.keys(cart).length > 0 && <Button onClick={commitPurchase} variant="success">Receive Stock & Log Expense</Button>}
            </div>
            <div className="bg-white rounded-xl border overflow-hidden">
                <table className="w-full text-left">
                    <thead className="bg-slate-50 text-slate-500"><tr><th className="p-4">Material</th><th className="p-4">Cost</th><th className="p-4">Current</th><th className="p-4">Order Qty</th><th className="p-4">Subtotal</th></tr></thead>
                    <tbody className="divide-y">
                        {materials.map(mat => {
                            const qty = cart[mat.id] || 0;
                            return (
                                <tr key={mat.id}>
                                    <td className="p-4 font-medium">{mat.name}</td>
                                    <td className="p-4">{formatCurrency(mat.cost)}</td>
                                    <td className="p-4">{mat.stock}</td>
                                    <td className="p-4"><input type="number" min="0" className="border p-1 rounded w-24" value={qty || ''} onChange={e => setCart({...cart, [mat.id]: Number(e.target.value)})} placeholder="0" /></td>
                                    <td className="p-4 font-mono">{formatCurrency(qty * mat.cost)}</td>
                                </tr>
                            )
                        })}
                    </tbody>
                </table>
            </div>
        </div>
    )
  };

  const InvoiceView = () => {
    const [mode, setMode] = useState('list'); // list, create, view
    const [currentInvoice, setCurrentInvoice] = useState(null);
    
    // Create State
    const [invBuyerId, setInvBuyerId] = useState('');
    const [invItems, setInvItems] = useState([]); // { prodId, qty, price, name }
    const [invTempItem, setInvTempItem] = useState({ prodId: '', qty: 1 });

    const addItem = () => {
        if(!invTempItem.prodId) return;
        const prod = products.find(p => p.id === invTempItem.prodId);
        setInvItems([...invItems, { 
            prodId: prod.id, 
            qty: Number(invTempItem.qty), 
            price: prod.sellingPrice, 
            name: prod.name 
        }]);
        setInvTempItem({ prodId: '', qty: 1 });
    };

    const generateInvoice = async () => {
        if(!invBuyerId || invItems.length === 0) return;
        const buyer = contacts.find(c => c.id === invBuyerId);
        const total = invItems.reduce((acc, item) => acc + (item.price * item.qty), 0);
        
        const batch = writeBatch(db);

        // Deduct Product Stock
        invItems.forEach(item => {
             const prod = products.find(p => p.id === item.prodId);
             if(prod) {
                 const ref = doc(db, 'artifacts', appId, 'public', 'data', 'products', prod.id);
                 batch.update(ref, { stock: (prod.stock || 0) - item.qty });
             }
        });

        // Create Invoice Record
        const invRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'invoices'));
        const invData = {
            invoiceNumber: `INV-${Date.now().toString().slice(-6)}`,
            buyerId: invBuyerId,
            buyerName: buyer.name,
            buyerAddress: buyer.address,
            buyerPhone: buyer.phone,
            items: invItems,
            total: total,
            date: new Date().toISOString(),
        };
        batch.set(invRef, invData);

        // Create Transaction
        const transRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'));
        batch.set(transRef, {
            type: 'income',
            amount: total,
            date: new Date().toISOString(),
            description: `Invoice ${invData.invoiceNumber} to ${buyer.name}`,
            relatedId: invRef.id
        });

        await batch.commit();
        setMode('list');
        setInvItems([]);
        setInvBuyerId('');
    };

    if (mode === 'view' && currentInvoice) {
        return (
            <div className="bg-white min-h-screen">
                <div className="print:hidden p-4 border-b flex justify-between items-center bg-slate-50">
                    <Button onClick={() => setMode('list')} variant="secondary" icon={ArrowLeft}>Back</Button>
                    <div className="flex gap-2">
                        <Button onClick={() => window.print()} icon={Printer}>Print Invoice</Button>
                    </div>
                </div>
                
                {/* Invoice Layout - A4 optimized via CSS */}
                <div className="max-w-3xl mx-auto p-8 md:p-12 print:p-0 print:max-w-full">
                    {/* Header */}
                    <div className="flex justify-between items-start mb-12">
                        <div>
                            <h1 className="text-4xl font-bold text-slate-900 mb-2">INVOICE</h1>
                            <p className="text-slate-500 font-mono">#{currentInvoice.invoiceNumber}</p>
                        </div>
                        <div className="text-right">
                            <h3 className="font-bold text-xl text-indigo-600">XYZ Company</h3>
                            <p className="text-slate-600">123 Random Business Park</p>
                            <p className="text-slate-600">Innovation City, IN 45000</p>
                            <p className="text-slate-600">contact@xyzcompany.com</p>
                        </div>
                    </div>

                    {/* Bill To */}
                    <div className="mb-12 flex justify-between">
                        <div>
                            <h4 className="text-xs font-bold uppercase text-slate-400 mb-2 tracking-wider">Bill To</h4>
                            <p className="font-bold text-lg text-slate-800">{currentInvoice.buyerName}</p>
                            <p className="text-slate-600 whitespace-pre-line">{currentInvoice.buyerAddress}</p>
                            <p className="text-slate-600">{currentInvoice.buyerPhone}</p>
                        </div>
                        <div className="text-right">
                             <div className="mb-2">
                                <span className="text-slate-400 text-xs font-bold uppercase mr-4">Date</span>
                                <span className="font-medium text-slate-800">{formatDate(currentInvoice.date)}</span>
                             </div>
                             <div>
                                <span className="text-slate-400 text-xs font-bold uppercase mr-4">Total Due</span>
                                <span className="font-bold text-xl text-emerald-600">{formatCurrency(currentInvoice.total)}</span>
                             </div>
                        </div>
                    </div>

                    {/* Items */}
                    <table className="w-full mb-12">
                        <thead className="border-b-2 border-slate-900">
                            <tr>
                                <th className="text-left py-3 font-bold text-slate-800">Item Description</th>
                                <th className="text-right py-3 font-bold text-slate-800">Quantity</th>
                                <th className="text-right py-3 font-bold text-slate-800">Unit Price</th>
                                <th className="text-right py-3 font-bold text-slate-800">Amount</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                            {currentInvoice.items.map((item, i) => (
                                <tr key={i}>
                                    <td className="py-4 text-slate-700 font-medium">{item.name}</td>
                                    <td className="py-4 text-right text-slate-600">{item.qty}</td>
                                    <td className="py-4 text-right text-slate-600">{formatCurrency(item.price)}</td>
                                    <td className="py-4 text-right font-bold text-slate-800">{formatCurrency(item.qty * item.price)}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>

                    {/* Footer */}
                    <div className="border-t-2 border-slate-100 pt-8 flex justify-end">
                        <div className="w-1/2">
                             <div className="flex justify-between py-2">
                                <span className="font-medium text-slate-600">Subtotal</span>
                                <span className="font-bold text-slate-800">{formatCurrency(currentInvoice.total)}</span>
                            </div>
                            <div className="flex justify-between py-2 border-t border-slate-200">
                                <span className="font-bold text-lg text-slate-800">Total</span>
                                <span className="font-bold text-2xl text-indigo-600">{formatCurrency(currentInvoice.total)}</span>
                            </div>
                        </div>
                    </div>

                    <div className="mt-16 text-center text-slate-400 text-sm">
                        <p>Thank you for your business!</p>
                    </div>
                </div>
            </div>
        );
    }

    if (mode === 'create') {
        return (
            <div className="max-w-4xl mx-auto space-y-6">
                 <div className="flex items-center gap-4">
                     <Button onClick={() => setMode('list')} variant="secondary" icon={ArrowLeft}>Cancel</Button>
                     <h2 className="text-2xl font-bold">New Invoice</h2>
                 </div>

                 <Card title="Customer Details">
                     <label className="block text-sm font-medium mb-1">Select Buyer</label>
                     <select className="w-full border p-2 rounded" value={invBuyerId} onChange={e => setInvBuyerId(e.target.value)}>
                         <option value="">Select Customer...</option>
                         {contacts.filter(c => c.type !== 'seller').map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                     </select>
                 </Card>

                 <Card title="Items">
                     <div className="flex gap-2 mb-4">
                         <select className="flex-1 border p-2 rounded" value={invTempItem.prodId} onChange={e => setInvTempItem({...invTempItem, prodId: e.target.value})}>
                             <option value="">Add Product...</option>
                             {products.map(p => <option key={p.id} value={p.id}>{p.name} ({formatCurrency(p.sellingPrice)})</option>)}
                         </select>
                         <input type="number" className="w-24 border p-2 rounded" value={invTempItem.qty} onChange={e => setInvTempItem({...invTempItem, qty: e.target.value})} />
                         <Button onClick={addItem} variant="secondary">Add</Button>
                     </div>
                     <table className="w-full text-left">
                         <thead className="bg-slate-50"><tr><th className="p-2">Item</th><th className="p-2">Qty</th><th className="p-2">Price</th><th className="p-2">Total</th><th></th></tr></thead>
                         <tbody>
                             {invItems.map((item, i) => (
                                 <tr key={i} className="border-b">
                                     <td className="p-2">{item.name}</td>
                                     <td className="p-2">{item.qty}</td>
                                     <td className="p-2">{formatCurrency(item.price)}</td>
                                     <td className="p-2 font-bold">{formatCurrency(item.qty * item.price)}</td>
                                     <td className="p-2"><button onClick={() => setInvItems(invItems.filter((_, idx) => idx !== i))} className="text-red-500">&times;</button></td>
                                 </tr>
                             ))}
                         </tbody>
                     </table>
                     <div className="mt-4 text-right">
                         <p className="text-xl font-bold">Total: {formatCurrency(invItems.reduce((a,b) => a + (b.price * b.qty), 0))}</p>
                     </div>
                 </Card>

                 <div className="flex justify-end">
                     <Button onClick={generateInvoice} variant="success" icon={FileText} disabled={!invBuyerId || invItems.length === 0}>Generate Invoice</Button>
                 </div>
            </div>
        )
    }

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-end">
                <div><h2 className="text-2xl font-bold text-slate-800">Invoices</h2><p className="text-slate-500">Manage customer billing</p></div>
                <Button onClick={() => setMode('create')} icon={Plus}>New Invoice</Button>
            </div>
            
            <div className="bg-white rounded-xl shadow border overflow-hidden">
                <table className="w-full text-left">
                    <thead className="bg-slate-50 text-slate-500"><tr><th className="p-4">#</th><th className="p-4">Date</th><th className="p-4">Customer</th><th className="p-4">Amount</th><th className="p-4"></th></tr></thead>
                    <tbody className="divide-y">
                        {invoices.map(inv => (
                            <tr key={inv.id} className="hover:bg-slate-50">
                                <td className="p-4 font-mono text-slate-600">{inv.invoiceNumber}</td>
                                <td className="p-4">{formatDate(inv.date)}</td>
                                <td className="p-4 font-medium">{inv.buyerName}</td>
                                <td className="p-4 font-bold text-slate-800">{formatCurrency(inv.total)}</td>
                                <td className="p-4 text-right">
                                    <Button variant="ghost" onClick={() => { setCurrentInvoice(inv); setMode('view'); }} className="!py-1">View/Print</Button>
                                </td>
                            </tr>
                        ))}
                         {invoices.length === 0 && <tr><td colSpan={5} className="p-8 text-center text-slate-400">No invoices generated yet.</td></tr>}
                    </tbody>
                </table>
            </div>
        </div>
    );
  };

  const FinancialsView = () => (
      <div className="space-y-6">
          <h2 className="text-2xl font-bold text-slate-800">Financial Ledger</h2>
          <div className="bg-white rounded-xl shadow border overflow-hidden">
              <table className="w-full text-left">
                  <thead className="bg-slate-50 text-slate-500"><tr><th className="p-4">Date</th><th className="p-4">Description</th><th className="p-4">Type</th><th className="p-4 text-right">Amount</th></tr></thead>
                  <tbody className="divide-y">
                      {transactions.map(t => (
                          <tr key={t.id} className="hover:bg-slate-50">
                              <td className="p-4 text-slate-500 whitespace-nowrap">{formatDate(t.date)}</td>
                              <td className="p-4 font-medium">{t.description}</td>
                              <td className="p-4"><span className={`px-2 py-1 rounded text-xs font-bold uppercase ${t.type === 'income' ? 'bg-emerald-100 text-emerald-700' : 'bg-orange-100 text-orange-700'}`}>{t.type}</span></td>
                              <td className={`p-4 text-right font-mono font-bold ${t.type === 'income' ? 'text-emerald-600' : 'text-red-600'}`}>
                                  {t.type === 'income' ? '+' : '-'}{formatCurrency(t.amount)}
                              </td>
                          </tr>
                      ))}
                      {transactions.length === 0 && <tr><td colSpan={4} className="p-8 text-center text-slate-400">No transactions recorded.</td></tr>}
                  </tbody>
              </table>
          </div>
      </div>
  );

  if (loading) return <LoadingScreen />;

  return (
    <div className="flex min-h-screen bg-slate-100 font-sans text-slate-900">
      {/* Sidebar - Hidden when printing */}
      <div className="w-20 lg:w-64 bg-slate-900 text-white flex flex-col fixed h-full z-10 transition-all duration-300 print:hidden">
        <div className="p-6 flex items-center justify-center lg:justify-start gap-3 border-b border-slate-800">
          <Boxes className="text-indigo-400" size={28} />
          <span className="font-bold text-xl hidden lg:block tracking-tight">Material<span className="text-indigo-400">Master</span></span>
        </div>
        
        <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
           {[
               { id: 'dashboard', label: 'Dashboard', icon: LayoutDashboard },
               { id: 'inventory', label: 'Inventory', icon: Package },
               { id: 'formulas', label: 'Products', icon: FlaskConical },
               { id: 'production', label: 'Production', icon: Factory },
               { id: 'purchasing', label: 'Purchasing', icon: ShoppingCart },
               { id: 'invoices', label: 'Invoices', icon: FileText },
               { id: 'financials', label: 'Financials', icon: DollarSign },
               { id: 'contacts', label: 'Contacts', icon: Users },
           ].map(item => (
              <button 
                key={item.id}
                onClick={() => setActiveTab(item.id)}
                className={`w-full flex items-center p-3 rounded-lg transition-all ${activeTab === item.id ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-900/50' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}
              >
                <item.icon size={20} className="lg:mr-3" />
                <span className="hidden lg:block font-medium">{item.label}</span>
              </button>
           ))}
        </nav>
      </div>

      {/* Main Content */}
      <div className="flex-1 ml-20 lg:ml-64 print:ml-0">
        <div className="p-8 print:p-0">
            <div className="max-w-7xl mx-auto print:max-w-none">
            {activeTab === 'dashboard' && <DashboardView />}
            {activeTab === 'inventory' && <InventoryView />}
            {activeTab === 'formulas' && <FormulasView />}
            {activeTab === 'production' && <ProductionView />}
            {activeTab === 'purchasing' && <PurchasingView />}
            {activeTab === 'invoices' && <InvoiceView />}
            {activeTab === 'financials' && <FinancialsView />}
            {activeTab === 'contacts' && <ContactsView />}
            </div>
        </div>
      </div>
    </div>
  );
}
