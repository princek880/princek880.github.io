<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoCam Capture</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #111;
            color: #eee;
            margin: 0;
            padding: 20px;
        }
        video, canvas, img {
            max-width: 100%;
            border: 2px solid #444;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        canvas {
            display: none; /* Hidden canvas for processing */
        }
        #controls {
            display: flex;
            gap: 10px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        #preview-container {
            margin-top: 10px;
            text-align: center;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>

    <h2>Geo-Timestamp Camera</h2>
    
    <video id="video" autoplay playsinline></video>
    
    <canvas id="canvas"></canvas>

    <div id="controls">
        <button id="capture-btn">Capture Photo</button>
        <a id="download-link" class="hidden">
            <button id="download-btn">Download Image</button>
        </a>
    </div>

    <div id="preview-container">
        <img id="photo-preview" class="hidden" alt="Capture Preview">
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('capture-btn');
        const downloadLink = document.getElementById('download-link');
        const photoPreview = document.getElementById('photo-preview');
        const ctx = canvas.getContext('2d');

        let currentLat = null;
        let currentLon = null;

        // Initialize Camera
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" }, 
                    audio: false 
                });
                video.srcObject = stream;
            } catch (err) {
                alert("Error accessing camera: " + err.message);
            }
        }

        // Initialize Location
        function initLocation() {
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        currentLat = position.coords.latitude.toFixed(5);
                        currentLon = position.coords.longitude.toFixed(5);
                    },
                    (error) => {
                        console.error("Location error:", error);
                        currentLat = "N/A";
                        currentLon = "N/A";
                    },
                    { enableHighAccuracy: true }
                );
            } else {
                currentLat = "Unsupported";
                currentLon = "Unsupported";
            }
        }

        // Capture and Process Image
        captureBtn.addEventListener('click', () => {
            // Set canvas dimensions to match video stream
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw video frame to canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Overlay styling
            const timestamp = new Date().toLocaleString();
            const locationText = `Lat: ${currentLat || 'Waiting...'}, Lon: ${currentLon || 'Waiting...'}`;
            
            ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
            ctx.fillRect(0, canvas.height - 60, canvas.width, 60); // Background bar
            
            ctx.fillStyle = "white";
            ctx.font = "20px Arial";
            ctx.textAlign = "left";
            ctx.fillText(timestamp, 15, canvas.height - 35);
            ctx.fillText(locationText, 15, canvas.height - 10);

            // Generate Image URL
            const dataURL = canvas.toDataURL('image/png');
            
            // Show Preview
            photoPreview.src = dataURL;
            photoPreview.classList.remove('hidden');

            // Setup Download
            downloadLink.href = dataURL;
            downloadLink.download = `capture_${Date.now()}.png`;
            downloadLink.classList.remove('hidden');
        });

        // Start services
        initCamera();
        initLocation();
    </script>
</body>
</html>
